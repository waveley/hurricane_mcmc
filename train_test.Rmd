---
title: "train test"
author: "Haolin Zhong"
date: "2022/5/5"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Data Preparation

```{r}
library(tidyverse)
library(lubridate)
library(extraDistr)
library(MASS)
library(mixAK)


raw = read_csv("hurricane_mcmc/data/hurrican703.csv") %>% 
  janitor::clean_names() %>% 
  dplyr::select(-month) %>% 
  mutate(
    time = gsub("[()]", "", time),
    time = parse_datetime(time, "%y-%m-%d %H:%M:%S")
  ) %>% 
  mutate(
    month = month(time)
  ) %>% 
  filter(hour(time) %in% c(0, 6, 12, 18),
         minute(time) == 0,
         second(time) == 0)

placeholder = data.frame(id = "placeholder", 
                        time = parse_datetime("00-01-01 00:00:00", "%y-%m-%d %H:%M:%S"), 
                        season = 2048,
                        nature = "PH",
                        latitude = 0, 
                        longitude = 0,
                        wind_kt = 0,
                        month = 0)

dt = bind_cols(rbind(raw, placeholder), 
          rbind(placeholder, raw), 
          .name_repair = "unique")  

dt = dt[2:(nrow(dt)-1),]

dt

dt = dt %>% 
  filter(id...1 == id...9,
         time...10 + 6*60*60 == time...4) %>% 
  mutate(
    d_lat = latitude...5 - latitude...13,
    d_log = longitude...6 - longitude...14,
    d_wkt = wind_kt...7 - wind_kt...15
  ) %>% 
  dplyr::select(id = id...1, wkt_new = wind_kt...7, wkt_cur = wind_kt...15, 
                d_lat, d_log, d_wkt, year = season...11, 
                month = month...16, type = nature...12)

hc = distinct(dt, id) %>% add_rownames("i")

hc

dt = dt %>% left_join(hc)

head(dt)
```

## for problem 5

```{r}
dt %>% group_by(i) %>% slice(1) %>% arrange(as.numeric(i))
```

## train / test

Here we use stratified sampling to sample 80% of data for each hurricane as train data, and use the rest 20% as test data.

```{r}
library(tidyverse)

set.seed(2022)
train_index = rownames_to_column(dt) %>% 
  group_by(i) %>% 
  sample_frac(0.8) %>% 
  pull(rowname) %>% 
  as.numeric()

train = dt[train_index,]
test = dt[-train_index,]

test
```


```{r}
B = matrix(rep(1, 5*700), nrow = 700)

my.predict = function(B, newdata) {
  res = data.frame()
  hrcans = newdata %>% pull(i) %>% as.numeric() %>% unique()
  for (i in hrcans) {
    x = as.matrix(cbind(intercept = 1, test[test[,"i"] == i,][,3:6]))
    pred = as.data.frame(t(B[i,] %*% t(x)))
    res = rbind(res, c(pred))
  }
  return(res$V1)
}

```


```{r}
library(ModelMetrics)
rmse(pred, test$wkt_new)
```


